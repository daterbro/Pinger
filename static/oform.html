<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration and Login</title>
    <link rel="icon" type="image/png" href="/static/avatar.png">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        input {
            width: 300px;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            width: 200px;
            padding: 10px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background-color: #45a049;
        }
        #response {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }
        .password-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 300px;
        }
        input[type="password"] {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            margin: 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .toggle-password {
            margin-left: 10px;
            background-color: transparent;
            border: none;
            color: #4CAF50;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            height: 100%;
            display: flex;
            align-items: center;
        }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>Registration and Login</h2>
        <input type="email" id="email" placeholder="Enter your email" required>
        <div class="password-container">
            <input type="password" id="password" placeholder="Enter your password" required>
            <button class="toggle-password" id="togglePassword">üëÅÔ∏è</button>
        </div>
        <br>
        <button id="registerButton">Registration</button>
        <button id="loginButton">Login</button>
        <div id="response"></div>
    </div>

    <script>
        let socket;
        let userId; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è user_id
        let token; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

        function connectWebSocket() {
            // –í—ã–±–æ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ WebSocket –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
         const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
         const socketUrl = `${protocol}192.168.0.108:8080/ws`;
            socket = new WebSocket(socketUrl);

            socket.onopen = function() {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            };

            socket.onerror = function(event) {
                console.error("–û—à–∏–±–∫–∞ WebSocket:", event);
            };

            socket.onclose = function(event) {
                console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ:', event);
                setTimeout(connectWebSocket, 1000);
            };

            socket.onmessage = function(event) {
                const response = JSON.parse(event.data);
                document.getElementById('response').innerText = response.message;
                console.log("Received data:", response); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

                if (response.status === "success") {
                    userId = response.user_id;
                    token = response.token; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                    sessionStorage.setItem('userId', userId); 
                    sessionStorage.setItem('token', token); 
                    console.log('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, userId –∏ —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', userId, token);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
                    setTimeout(() => {
                        window.location.href = "main.html"; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    }, 7000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 7 —Å–µ–∫—É–Ω–¥ (7000 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)
                }
            };
        }


        window.onload = function() {
            const storedUserId = sessionStorage.getItem('userId'); 
            const storedToken = sessionStorage.getItem('token'); 
            if (storedUserId && storedToken) {
                window.location.href = "main.html"; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–ª–∞–≥–∞ –≤ sessionStorage
            if (sessionStorage.getItem('mainPageOpen')) {
                alert("–í—ã —É–∂–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–∫—Ä–æ–π—Ç–µ —ç—Ç—É –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                window.location.href = "main.html"; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            } else {
                sessionStorage.setItem('mainPageOpen', 'true'); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
            }

            connectWebSocket();
        };

        document.getElementById('registerButton').onclick = function() {
            let email = document.getElementById("email").value.trim();  // –û–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
            const password = document.getElementById("password").value;

            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", { email, password });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
                alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email");
                return;
            }

            if (email && password) {
                socket.send(JSON.stringify({
                    command: "register",
                    email: email,
                    password: password
                }));
            } else {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
            }
        };

        document.getElementById('loginButton').onclick = function() {
            let email = document.getElementById("email").value.trim();  // –û–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
            const password = document.getElementById("password").value;

            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Ö–æ–¥–∞:", { email, password });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(email)) {
                alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email");
                return;
            }

            if (email && password) {
                socket.send(JSON.stringify({
                    command: "login",
                    email: email,
                    password: password
                }));
            } else {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
            }
        };

        document.getElementById('togglePassword').onclick = function() {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        };

        // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        window.onbeforeunload = function() {
            sessionStorage.removeItem('mainPageOpen'); // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥
        };
    </script>
</body>
</html>
